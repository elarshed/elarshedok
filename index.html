<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مستشار التسعير الذكي - مصر</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <!-- Google Fonts (Cairo) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #f9fafb, #e5e7eb);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1rem;
    }
    .section {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      transition: transform 0.3s ease;
    }
    .section:hover {
      transform: translateY(-5px);
    }
    .tab {
      padding: 0.5rem 1.25rem;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #4b5563;
      transition: all 0.3s ease;
      border-radius: 0.5rem 0.5rem 0 0;
      background: #f1f5f9;
    }
    .tab.active {
      border-color: #1e40af;
      color: #1e40af;
      background: #dbeafe;
    }
    .tab:hover {
      color: #1e40af;
      background: #eff6ff;
    }
    .input-group {
      position: relative;
      margin-bottom: 1rem;
    }
    .input {
      width: 100%;
      padding: 0.5rem 2rem 0.5rem 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      background: #f9fafb;
      font-size: 0.875rem;
    }
    .input:focus {
      border-color: #1e40af;
      box-shadow: 0 0 6px rgba(30, 64, 175, 0.5);
      outline: none;
      background: white;
    }
    .input-icon {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }
    .input-desc {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .btn {
      padding: 0.5rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.15);
    }
    .dashboard-card {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .dashboard-card:hover {
      transform: scale(1.03);
    }
    .dashboard-desc {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .chart-container {
      height: 250px;
      width: 100%;
      background: white;
      border-radius: 0.75rem;
      padding: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .alert {
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      animation: fadeIn 0.6s ease-in-out;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .alert-error { background-color: #fee2e2; color: #991b1b; }
    .alert-success { background-color: #d1fae5; color: #065f46; }
    .alert-info { background-color: #dbeafe; color: #1e40af; }
    .slider { width: 100%; margin-top: 0.25rem; }
    .recommendation {
      background: #fef3c7;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-top: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .container { padding: 0.75rem; }
      .section { padding: 1rem; }
      .tab { padding: 0.4rem 1rem; font-size: 0.75rem; }
      .dashboard-card { padding: 0.75rem; }
      .input { font-size: 0.75rem; padding: 0.4rem 1.5rem 0.4rem 0.4rem; }
      .input-desc { font-size: 0.65rem; }
      .btn { padding: 0.4rem 1rem; font-size: 0.75rem; }
      .dashboard-card p:first-child { font-size: 0.75rem; }
      .dashboard-card p:nth-child(2) { font-size: 1.25rem; }
      .text-2xl { font-size: 1.25rem; }
      .text-xl { font-size: 1rem; }
    }
    @media print {
      .no-print { display: none; }
      body { background: white; }
      .section { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-200 no-print">
      <span class="tab active" data-tab="products">المنتجات</span>
      <span class="tab" data-tab="competition">المنافسة</span>
      <span class="tab" data-tab="ads">الإعلانات</span>
      <span class="tab" data-tab="dashboard">لوحة التحكم</span>
    </div>

    <!-- Products Section -->
    <div id="products" class="section tab-content active">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-box"></i> المنتجات بتاعتك
      </h2>
      <div id="productList" class="space-y-4"></div>
      <button id="addProduct" class="btn bg-blue-600 text-white hover:bg-blue-700 mt-4 no-print">
        <i class="fas fa-plus"></i> زوّد منتج
      </button>
      <button id="calculateIdealPrice" class="btn bg-green-600 text-white hover:bg-green-700 mt-4 no-print">
        <i class="fas fa-calculator"></i> احسب لي السعر المثالي
      </button>
    </div>

    <!-- Competition Section -->
    <div id="competition" class="section tab-content hidden">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-users"></i> المنافسين بتوعك
      </h2>
      <div id="competitorList" class="space-y-4"></div>
      <button id="addCompetitor" class="btn bg-blue-600 text-white hover:bg-blue-700 mt-4 no-print">
        <i class="fas fa-plus"></i> زوّد منافس
      </button>
    </div>

    <!-- Ads Section -->
    <div id="ads" class="section tab-content hidden">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-ad"></i> الإعلانات بتاعتك
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="input-group">
          <label class="block mb-1 font-semibold">تكلفة النقرة (جنيه)</label>
          <input id="cpc" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-mouse-pointer input-icon"></i>
          <p class="input-desc">كل نقرة بتكلفك كام؟ (مثل: 5 جنيه)</p>
        </div>
        <div class="input-group">
          <label class="block mb-1 font-semibold">عدد النقرات الشهرية</label>
          <input id="clicks" type="number" class="input" value="0" min="0" />
          <i class="fas fa-hand-pointer input-icon"></i>
          <p class="input-desc">كام واحد بينقر كل شهر؟ (مثل: 200)</p>
        </div>
        <div class="input-group">
          <label class="block mb-1 font-semibold">نسبة التحويل (%)</label>
          <input id="conversionRate" type="number" class="input" value="0" min="0" max="100" />
          <i class="fas fa-percentage input-icon"></i>
          <p class="input-desc">كام في المية بيشتروا؟ (مثل: 5%)</p>
        </div>
        <div class="input-group">
          <label class="block mb-1 font-semibold">نسبة المرتجعات من COD (%)</label>
          <input id="codReturnRate" type="number" class="input" value="0" min="0" max="100" />
          <i class="fas fa-undo input-icon"></i>
          <p class="input-desc">كام في المية بيرجّعوا؟ (مثل: 20%)</p>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="section tab-content hidden">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <i class="fas fa-tachometer-alt"></i> لوحة التحكم بتاعتك
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">إجمالي المبيعات</p>
          <p id="dashRevenue" class="text-2xl font-bold text-blue-600">ج.م 0</p>
          <p class="dashboard-desc">الفلوس اللي هتدخل جيبك.</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">صافي الربح</p>
          <p id="dashNetProfit" class="text-2xl font-bold">ج.م 0</p>
          <p class="dashboard-desc">اللي هيفضل بعد المصاريف.</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">نقطة التعادل</p>
          <p id="dashBreakEven" class="text-2xl font-bold text-yellow-600">0 طلب</p>
          <p class="dashboard-desc">كام طلب عشان تغطي التكلفة؟</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">ROI الإعلانات</p>
          <p id="dashROI" class="text-2xl font-bold text-purple-600">0%</p>
          <p class="dashboard-desc">كل جنيه بيرجع كام؟</p>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="costBreakdownChart"></canvas>
      </div>
      <div id="recommendations" class="recommendation">
        <h3 class="text-xl font-bold mb-3">نصايح ذكية عشان تكسب أكتر</h3>
        <ul id="recommendationList" class="list-disc pr-4 text-sm"></ul>
      </div>
      <div class="mt-4">
        <h3 class="text-xl font-bold mb-3">جرب بنفسك: ماذا لو؟</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="input-group">
            <label class="block mb-1 font-semibold">السعر</label>
            <input type="range" id="priceSlider" class="slider" min="0" max="2000" value="0" />
            <p id="priceValue" class="input-desc">ج.م 0</p>
          </div>
          <div class="input-group">
            <label class="block mb-1 font-semibold">تكلفة الإعلان</label>
            <input type="range" id="adCostSlider" class="slider" min="0" max="50" value="0" />
            <p id="adCostValue" class="input-desc">ج.م 0</p>
          </div>
          <div class="input-group">
            <label class="block mb-1 font-semibold">نسبة المرتجعات</label>
            <input type="range" id="returnRateSlider" class="slider" min="0" max="100" value="0" />
            <p id="returnRateValue" class="input-desc">0%</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3 mt-4 no-print">
      <button id="calculate" class="btn bg-green-600 text-white hover:bg-green-700">
        <i class="fas fa-calculator"></i> احسب كل حاجة
      </button>
      <button id="reset" class="btn bg-red-600 text-white hover:bg-red-700">
        <i class="fas fa-undo"></i> ابدأ من الأول
      </button>
      <button id="print" class="btn bg-gray-600 text-white hover:bg-gray-700">
        <i class="fas fa-print"></i> اطبع التقرير
      </button>
    </div>
  </div>

  <script>
    // البيانات العالمية
    let products = [{ name: "منتج 1", buyPrice: 0, shipping: 0, otherCosts: 0, expectedDeliveries: 0, targetSegment: "متوسطة" }];
    let competitors = [];
    let currency = "ج.م";
    let costChart = null;

    // تحميل البيانات من LocalStorage
    if (localStorage.getItem("products")) products = JSON.parse(localStorage.getItem("products"));
    if (localStorage.getItem("competitors")) competitors = JSON.parse(localStorage.getItem("competitors"));

    // تبديل التبويبات
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.remove("hidden");
        calculateAll(); // تحديث الحسابات عند التبديل
      });
    });

    // عرض المنتجات
    function renderProducts() {
      const productList = document.getElementById("productList");
      productList.innerHTML = "";
      products.forEach((product, index) => {
        const div = document.createElement("div");
        div.className = "border rounded-lg p-3 bg-gray-50 shadow-sm transition-all duration-300 hover:bg-gray-100";
        div.innerHTML = `
          <div class="flex justify-between items-center mb-3">
            <div class="input-group w-1/3">
              <input type="text" value="${product.name}" class="input" data-index="${index}" data-field="name" placeholder="اسم المنتج" />
              <i class="fas fa-tag input-icon"></i>
              <p class="input-desc">المنتج اسمه إيه؟ (مثل: تيشيرت)</p>
            </div>
            <button class="text-red-600 hover:text-red-800 no-print" data-index="${index}">
              <i class="fas fa-trash"></i> امسح
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div class="input-group">
              <label class="block mb-1 font-semibold">سعر الشراء</label>
              <input type="number" value="${product.buyPrice}" class="input" data-index="${index}" data-field="buyPrice" min="0" step="0.01" />
              <i class="fas fa-shopping-cart input-icon"></i>
              <p class="input-desc">جبت المنتج بكام؟</p>
            </div>
            <div class="input-group">
              <label class="block mb-1 font-semibold">الشحن</label>
              <input type="number" value="${product.shipping}" class="input" data-index="${index}" data-field="shipping" min="0" step="0.01" />
              <i class="fas fa-truck input-icon"></i>
              <p class="input-desc">الشحن كلفك كام؟</p>
            </div>
            <div class="input-group">
              <label class="block mb-1 font-semibold">تكاليف زيادة</label>
              <input type="number" value="${product.otherCosts}" class="input" data-index="${index}" data-field="otherCosts" min="0" step="0.01" />
              <i class="fas fa-tools input-icon"></i>
              <p class="input-desc">مصاريف تانية؟</p>
            </div>
            <div class="input-group">
              <label class="block mb-1 font-semibold">التسليمات</label>
              <input type="number" value="${product.expectedDeliveries}" class="input" data-index="${index}" data-field="expectedDeliveries" min="0" />
              <i class="fas fa-shopping-bag input-icon"></i>
              <p class="input-desc">هتبيع كام وحدة؟</p>
            </div>
            <div class="input-group">
              <label class="block mb-1 font-semibold">الفئة</label>
              <select class="input" data-index="${index}" data-field="targetSegment">
                <option value="رخيصة" ${product.targetSegment === "رخيصة" ? "selected" : ""}>رخيصة (<300)</option>
                <option value="متوسطة" ${product.targetSegment === "متوسطة" ? "selected" : ""}>متوسطة (300-1000)</option>
                <option value="فاخرة" ${product.targetSegment === "فاخرة" ? "selected" : ""}>فاخرة (>1000)</option>
              </select>
              <i class="fas fa-users input-icon"></i>
              <p class="input-desc">هتبيع لمين؟</p>
            </div>
          </div>
        `;
        productList.appendChild(div);
      });

      productList.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", (e) => {
          const index = e.target.dataset.index;
          const field = e.target.dataset.field;
          products[index][field] = field === "name" || field === "targetSegment" ? e.target.value : Math.max(parseFloat(e.target.value) || 0, 0);
          localStorage.setItem("products", JSON.stringify(products));
          calculateAll();
        });
      });

      productList.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          if (products.length > 1) {
            products.splice(btn.dataset.index, 1);
            localStorage.setItem("products", JSON.stringify(products));
            renderProducts();
            calculateAll();
            showAlert("المنتج اتشال بنجاح!", "success");
          } else {
            showAlert("مش هينفع تمسح المنتج الوحيد!", "error");
          }
        });
      });
    }

    // عرض المنافسين
    function renderCompetitors() {
      const competitorList = document.getElementById("competitorList");
      competitorList.innerHTML = "";
      competitors.forEach((competitor, index) => {
        const div = document.createElement("div");
        div.className = "border rounded-lg p-3 bg-gray-50 shadow-sm transition-all duration-300 hover:bg-gray-100";
        div.innerHTML = `
          <div class="flex justify-between items-center mb-3">
            <div class="input-group w-1/3">
              <input type="text" value="${competitor.name}" class="input" data-index="${index}" data-field="name" placeholder="اسم المنافس" />
              <i class="fas fa-store input-icon"></i>
              <p class="input-desc">اسم المنافس إيه؟</p>
            </div>
            <button class="text-red-600 hover:text-red-800 no-print" data-index="${index}">
              <i class="fas fa-trash"></i> امسح
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="input-group">
              <label class="block mb-1 font-semibold">سعر المنافس</label>
              <input type="number" value="${competitor.price}" class="input" data-index="${index}" data-field="price" min="0" step="0.01" />
              <i class="fas fa-dollar-sign input-icon"></i>
              <p class="input-desc">بيبيع بكام؟</p>
            </div>
            <div class="input-group">
              <label class="block mb-1 font-semibold">مبيعاته</label>
              <input type="number" value="${competitor.sales}" class="input" data-index="${index}" data-field="sales" min="0" />
              <i class="fas fa-shopping-bag input-icon"></i>
              <p class="input-desc">بيبيع كام وحدة؟</p>
            </div>
          </div>
        `;
        competitorList.appendChild(div);
      });

      competitorList.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", (e) => {
          const index = e.target.dataset.index;
          const field = e.target.dataset.field;
          competitors[index][field] = field === "name" ? e.target.value : Math.max(parseFloat(e.target.value) || 0, 0);
          localStorage.setItem("competitors", JSON.stringify(competitors));
          calculateAll();
        });
      });

      competitorList.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          competitors.splice(btn.dataset.index, 1);
          localStorage.setItem("competitors", JSON.stringify(competitors));
          renderCompetitors();
          calculateAll();
          showAlert("المنافس اتشال بنجاح!", "success");
        });
      });
    }

    // إضافة منتج
    document.getElementById("addProduct").addEventListener("click", () => {
      products.push({ name: `منتج ${products.length + 1}`, buyPrice: 0, shipping: 0, otherCosts: 0, expectedDeliveries: 0, targetSegment: "متوسطة" });
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts();
      calculateAll();
      showAlert("منتج جديد اتزوّد!", "success");
    });

    // إضافة منافس
    document.getElementById("addCompetitor").addEventListener("click", () => {
      competitors.push({ name: `منافس ${competitors.length + 1}`, price: 0, sales: 0 });
      localStorage.setItem("competitors", JSON.stringify(competitors));
      renderCompetitors();
      calculateAll();
      showAlert("منافس جديد اتزوّد!", "success");
    });

    // الحسابات الأساسية
    function calculateAll() {
      if (products.length === 0) {
        showAlert("لازم تزوّد منتج واحد على الأقل!", "error");
        return;
      }

      const cpc = Math.max(parseFloat(document.getElementById("cpc").value) || 0, 0);
      const clicks = Math.max(parseFloat(document.getElementById("clicks").value) || 0, 0);
      const conversionRate = Math.min(Math.max(parseFloat(document.getElementById("conversionRate").value) || 0, 0), 100);
      const codReturnRate = Math.min(Math.max(parseFloat(document.getElementById("codReturnRate").value) || 0, 0), 100);

      const productCosts = products.map(p => ({
        name: p.name,
        totalCost: p.buyPrice + p.shipping + p.otherCosts + 15, // 15 جنيه COD وتغليف
        expectedDeliveries: p.expectedDeliveries,
        targetSegment: p.targetSegment
      }));

      const totalExpectedOrders = productCosts.reduce((sum, p) => sum + p.expectedDeliveries, 0);
      const adCost = cpc * clicks;
      const ordersFromAds = clicks * (conversionRate / 100);
      const deliveredOrders = ordersFromAds * (1 - codReturnRate / 100);
      const returnCost = ordersFromAds * (codReturnRate / 100) * 20; // 20 جنيه لكل مرتجع

      // تحليل المنافسة
      const avgCompetitorPrice = competitors.length > 0 ? competitors.reduce((sum, c) => sum + c.price, 0) / competitors.length : 0;

      // السعر المثالي
      const suggestedPrices = productCosts.map(p => {
        let idealPrice = p.totalCost * 1.5; // هامش ربح 50%
        if (avgCompetitorPrice > 0) {
          idealPrice = Math.min(idealPrice * 1.2, avgCompetitorPrice * 1.1); // تنافسية
        }
        if (p.targetSegment === "رخيصة") idealPrice = Math.min(idealPrice, 299);
        else if (p.targetSegment === "متوسطة") idealPrice = Math.min(Math.max(idealPrice, 300), 999);
        else if (p.targetSegment === "فاخرة") idealPrice = Math.max(idealPrice, 1000);
        return {
          name: p.name,
          totalCost: p.totalCost,
          idealPrice: Math.round(idealPrice), // تقريب لأقرب جنيه
          profitPerOrder: Math.round(idealPrice - p.totalCost)
        };
      });

      // الحسابات المالية
      const totalRevenue = suggestedPrices.reduce((sum, p) => sum + p.idealPrice * p.expectedDeliveries, 0);
      const totalCost = suggestedPrices.reduce((sum, p) => sum + p.totalCost * p.expectedDeliveries, 0) + adCost + returnCost;
      const netProfit = totalRevenue - totalCost;
      const roi = adCost > 0 ? (netProfit / adCost) * 100 : 0;
      const breakEvenOrders = totalCost / (suggestedPrices[0]?.profitPerOrder || 1);

      // تحديث لوحة التحكم
      document.getElementById("dashRevenue").textContent = `${currency} ${totalRevenue.toFixed(2)}`;
      const dashNetProfit = document.getElementById("dashNetProfit");
      dashNetProfit.textContent = `${currency} ${netProfit.toFixed(2)}`;
      dashNetProfit.classList.toggle("text-red-600", netProfit < 0);
      document.getElementById("dashBreakEven").textContent = `${Math.ceil(breakEvenOrders)} طلب`;
      document.getElementById("dashROI").textContent = `${roi.toFixed(2)}%`;

      // تحديث المخطط
      updateChart(totalCost - adCost - returnCost, adCost, returnCost);

      // التوصيات الذكية
      const recommendationList = document.getElementById("recommendationList");
      recommendationList.innerHTML = "";
      suggestedPrices.forEach(p => {
        if (avgCompetitorPrice > 0) {
          const diff = ((avgCompetitorPrice - p.idealPrice) / avgCompetitorPrice * 100).toFixed(0);
          if (p.idealPrice < avgCompetitorPrice * 0.7) {
            recommendationList.innerHTML += `<li>سعر "${p.name}" أقل من السوق بـ ${diff}%، جرب تزوده عشان تكسب أكتر!</li>`;
          } else if (p.idealPrice > avgCompetitorPrice * 1.2) {
            recommendationList.innerHTML += `<li>سعر "${p.name}" أعلى من السوق بـ ${-diff}%، جرب تضيف ميزة عشان تنافس!</li>`;
          }
        }
        if (p.targetSegment === "متوسطة" && p.idealPrice > 800) {
          recommendationList.innerHTML += `<li>السعر بتاع "${p.name}" عالي على الطبقة المتوسطة، جرب عرض (اشتري 2 وخد 1)!</li>`;
        }
        if (p.targetSegment === "رخيصة" && p.idealPrice > 250) {
          recommendationList.innerHTML += `<li>السعر بتاع "${p.name}" عالي على الفئة الرخيصة، جرب تقلله شوية!</li>`;
        }
      });
      if (roi < 50 && adCost > 0) {
        recommendationList.innerHTML += `<li>الإعلانات مكلفة ومش بتجيب عائد كويس (ROI: ${roi.toFixed(0)}%)، جرب تستهدف ناس تانية!</li>`;
      } else if (roi > 150) {
        recommendationList.innerHTML += `<li>الإعلانات بتاعك جامدة (ROI: ${roi.toFixed(0)}%)، زود الميزانية عشان تبيع أكتر!</li>`;
      }
      if (codReturnRate > 25) {
        recommendationList.innerHTML += `<li>المرتجعات عالية (${codReturnRate}%)، جرب تكلم العملاء قبل التوصيل عشان تقللها!</li>`;
      }
      if (netProfit < 0) {
        recommendationList.innerHTML += `<li>الربح بتاعك في السالب، جرب تقلل التكاليف أو تزود السعر!</li>`;
      }

      // تحديث المنزلقات
      const priceSlider = document.getElementById("priceSlider");
      const adCostSlider = document.getElementById("adCostSlider");
      const returnRateSlider = document.getElementById("returnRateSlider");
      priceSlider.value = suggestedPrices[0]?.idealPrice || 0;
      adCostSlider.value = cpc;
      returnRateSlider.value = codReturnRate;
      document.getElementById("priceValue").textContent = `${currency} ${priceSlider.value}`;
      document.getElementById("adCostValue").textContent = `${currency} ${adCostSlider.value}`;
      document.getElementById("returnRateValue").textContent = `${returnRateSlider.value}%`;

      priceSlider.oninput = () => {
        document.getElementById("priceValue").textContent = `${currency} ${priceSlider.value}`;
        simulateWhatIf(parseFloat(priceSlider.value), parseFloat(adCostSlider.value), parseFloat(returnRateSlider.value));
      };
      adCostSlider.oninput = () => {
        document.getElementById("adCostValue").textContent = `${currency} ${adCostSlider.value}`;
        simulateWhatIf(parseFloat(priceSlider.value), parseFloat(adCostSlider.value), parseFloat(returnRateSlider.value));
      };
      returnRateSlider.oninput = () => {
        document.getElementById("returnRateValue").textContent = `${returnRateSlider.value}%`;
        simulateWhatIf(parseFloat(priceSlider.value), parseFloat(adCostSlider.value), parseFloat(returnRateSlider.value));
      };
    }

    // تحديث المخطط
    function updateChart(productCost, adCost, returnCost) {
      if (costChart) costChart.destroy();
      costChart = new Chart(document.getElementById("costBreakdownChart").getContext("2d"), {
        type: "pie",
        data: {
          labels: ["تكلفة المنتجات", "الإعلانات", "المرتجعات"],
          datasets: [{
            data: [productCost, adCost, returnCost],
            backgroundColor: ["#3b82f6", "#ef4444", "#f59e0b"],
            borderWidth: 1,
            borderColor: "#fff"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom", labels: { font: { size: 10 } } },
            title: { display: true, text: "تفصيل المصاريف", font: { size: 14 } }
          }
        }
      });
    }

    // محاكاة "ماذا لو؟"
    function simulateWhatIf(price, adCostPerClick, returnRate) {
      const clicks = Math.max(parseFloat(document.getElementById("clicks").value) || 0, 0);
      const conversionRate = Math.min(Math.max(parseFloat(document.getElementById("conversionRate").value) || 0, 0), 100);
      const totalCost = products[0].buyPrice + products[0].shipping + products[0].otherCosts + 15;
      const adCost = adCostPerClick * clicks;
      const orders = clicks * (conversionRate / 100);
      const deliveredOrders = orders * (1 - returnRate / 100);
      const returnCost = orders * (returnRate / 100) * 20;
      const revenue = price * deliveredOrders;
      const profit = revenue - (totalCost * deliveredOrders + adCost + returnCost);

      document.getElementById("dashRevenue").textContent = `${currency} ${revenue.toFixed(2)}`;
      const dashNetProfit = document.getElementById("dashNetProfit");
      dashNetProfit.textContent = `${currency} ${profit.toFixed(2)}`;
      dashNetProfit.classList.toggle("text-red-600", profit < 0);
    }

    // عرض التنبيهات
    function showAlert(message, type) {
      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      document.querySelector(".container").prepend(alertDiv);
      setTimeout(() => alertDiv.remove(), 4000);
    }

    // أحداث المستمعين
    document.querySelectorAll("input, select").forEach(input => {
      input.addEventListener("input", debounce(calculateAll, 200));
    });

    document.getElementById("calculateIdealPrice").addEventListener("click", () => {
      calculateAll();
      showAlert("السعر المثالي اتحسب، شوفه في لوحة التحكم!", "success");
    });

    document.getElementById("calculate").addEventListener("click", () => {
      calculateAll();
      showAlert("كل حاجة اتحسبت بنجاح!", "success");
    });

    document.getElementById("reset").addEventListener("click", () => {
      products = [{ name: "منتج 1", buyPrice: 0, shipping: 0, otherCosts: 0, expectedDeliveries: 0, targetSegment: "متوسطة" }];
      competitors = [];
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("competitors", JSON.stringify(competitors));
      document.querySelectorAll("input:not([type='range'])").forEach(input => input.value = "0");
      renderProducts();
      renderCompetitors();
      calculateAll();
      showAlert("كل حاجة رجعت زي الأول!", "success");
    });

    document.getElementById("print").addEventListener("click", () => {
      window.print();
      showAlert("التقرير بيطبع دلوقتي!", "success");
    });

    // Debounce Function
    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    }

    // التهيئة الأولية
    renderProducts();
    renderCompetitors();
    calculateAll();
  </script>
</body>
</html>
