<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مستشار التسعير الذكي للتجارة الإلكترونية</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <!-- Google Fonts (Cairo) -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    .container {
      max-width: 2200px;
      margin: 0 auto;
      padding: 6rem;
    }
    .section {
      background: white;
      border-radius: 3rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      padding: 6rem;
      margin-bottom: 6rem;
      transition: transform 0.4s ease;
    }
    .section:hover {
      transform: translateY(-25px);
    }
    .tab {
      padding: 2.75rem 5.5rem;
      border-bottom: 12px solid transparent;
      cursor: pointer;
      font-weight: 700;
      color: #374151;
      transition: all 0.3s ease;
      border-radius: 2.5rem 2.5rem 0 0;
      background: #e5e7eb;
    }
    .tab.active {
      border-color: #2563eb;
      color: #2563eb;
      background: #dbeafe;
    }
    .tab:hover {
      color: #2563eb;
      background: #f3f4f6;
    }
    .input-group {
      position: relative;
      margin-bottom: 5.5rem;
    }
    .input {
      width: 100%;
      padding: 1.75rem 6.5rem 1.75rem 1.75rem;
      border: 1px solid #d1d5db;
      border-radius: 2.25rem;
      transition: all 0.3s ease;
      background: #f9fafb;
      font-size: 1.35rem;
    }
    .input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 25px rgba(37, 99, 235, 0.5);
      outline: none;
      background: white;
    }
    .input-icon {
      position: absolute;
      right: 2.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }
    .input-desc {
      font-size: 1.25rem;
      color: #6b7280;
      margin-top: 1.75rem;
      line-height: 2;
    }
    .btn {
      padding: 1.75rem 5.5rem;
      border-radius: 2.25rem;
      font-weight: 700;
      transition: all 0.4s ease;
      display: flex;
      align-items: center;
      gap: 2.25rem;
      box-shadow: 0 14px 40px rgba(0,0,0,0.2);
    }
    .btn:hover {
      transform: translateY(-15px);
      box-shadow: 0 22px 50px rgba(0,0,0,0.3);
    }
    .dashboard-card {
      background: linear-gradient(145deg, #ffffff, #f9fafb);
      border-radius: 2.75rem;
      padding: 5.5rem;
      text-align: center;
      box-shadow: 0 18px 50px rgba(0,0,0,0.2);
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
    }
    .dashboard-card:hover {
      transform: scale(1.2) rotate(6deg);
      box-shadow: 0 25px 60px rgba(0,0,0,0.35);
    }
    .dashboard-desc {
      font-size: 1.25rem;
      color: #6b7280;
      margin-top: 2.25rem;
      line-height: 2;
    }
    .chart-container {
      height: 800px;
      width: 100%;
      background: white;
      border-radius: 3rem;
      padding: 5.5rem;
      box-shadow: 0 20px 55px rgba(0,0,0,0.15);
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5rem;
      background: #f9fafb;
      border-radius: 2.5rem;
      overflow: hidden;
      box-shadow: 0 16px 45px rgba(0,0,0,0.15);
    }
    .table th, .table td {
      border: 1px solid #e5e7eb;
      padding: 4rem;
      text-align: center;
    }
    .table th {
      background: #e5e7eb;
      font-weight: 700;
      color: #1f2937;
    }
    .alert {
      padding: 4rem;
      border-radius: 2.25rem;
      margin-bottom: 5rem;
      animation: fadeIn 1.2s ease-in-out;
      display: flex;
      align-items: center;
      gap: 3.5rem;
      box-shadow: 0 16px 45px rgba(0,0,0,0.2);
    }
    .alert-error { background-color: #fee2e2; color: #991b1b; }
    .alert-success { background-color: #d1fae5; color: #065f46; }
    .alert-info { background-color: #dbeafe; color: #1e40af; }
    .slider { width: 100%; margin-top: 1.75rem; }
    .recommendation {
      background: #fef3c7;
      padding: 4rem;
      border-radius: 2.25rem;
      margin-top: 5rem;
      box-shadow: 0 16px 45px rgba(0,0,0,0.15);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .container { padding: 5rem; }
      .section { padding: 5.5rem; }
      .tab { padding: 2.5rem 5rem; }
      .dashboard-card { padding: 5rem; }
    }
    @media print {
      .no-print { display: none; }
      body { background: white; }
      .section { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-16 mb-22 border-b border-gray-200 no-print">
      <span class="tab active" data-tab="products">المنتجات</span>
      <span class="tab" data-tab="competition">المنافسة</span>
      <span class="tab" data-tab="ads">الإعلانات</span>
      <span class="tab" data-tab="dashboard">لوحة التحكم</span>
    </div>

    <!-- Products Section -->
    <div id="products" class="section tab-content active">
      <h2 class="text-9xl font-bold mb-22 flex items-center gap-16">
        <i class="fas fa-box"></i> المنتجات بتاعتك
      </h2>
      <div id="productList" class="space-y-20"></div>
      <button id="addProduct" class="btn bg-blue-600 text-white hover:bg-blue-700 mt-20 no-print">
        <i class="fas fa-plus"></i> زوّد منتج جديد
      </button>
      <button id="calculateIdealPrice" class="btn bg-green-600 text-white hover:bg-green-700 mt-20 no-print">
        <i class="fas fa-calculator"></i> احسب لي السعر المثالي
      </button>
    </div>

    <!-- Competition Section -->
    <div id="competition" class="section tab-content hidden">
      <h2 class="text-9xl font-bold mb-22 flex items-center gap-16">
        <i class="fas fa-users"></i> المنافسين بتوعك
      </h2>
      <div id="competitorList" class="space-y-20"></div>
      <button id="addCompetitor" class="btn bg-blue-600 text-white hover:bg-blue-700 mt-20 no-print">
        <i class="fas fa-plus"></i> زوّد منافس جديد
      </button>
    </div>

    <!-- Ads Section -->
    <div id="ads" class="section tab-content hidden">
      <h2 class="text-9xl font-bold mb-22 flex items-center gap-16">
        <i class="fas fa-ad"></i> الإعلانات بتاعتك
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-22">
        <div class="input-group">
          <label class="block mb-2 font-semibold">تكلفة النقرة (CPC)</label>
          <input id="cpc" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-mouse-pointer input-icon"></i>
          <p class="input-desc">كام بتصرف على كل نقرة في الإعلان؟ (مثل: 10 جنيه)</p>
        </div>
        <div class="input-group">
          <label class="block mb-2 font-semibold">عدد النقرات الشهرية</label>
          <input id="clicks" type="number" class="input" value="0" min="0" />
          <i class="fas fa-hand-pointer input-icon"></i>
          <p class="input-desc">كام واحد بينقر على إعلانك كل شهر؟ (مثل: 500)</p>
        </div>
        <div class="input-group">
          <label class="block mb-2 font-semibold">نسبة التحويل (%)</label>
          <input id="conversionRate" type="number" class="input" value="0" min="0" max="100" />
          <i class="fas fa-percentage input-icon"></i>
          <p class="input-desc">كام في المية بيشتروا من النقرات؟ (مثل: 5%)</p>
        </div>
        <div class="input-group">
          <label class="block mb-2 font-semibold">نسبة المرتجعات من COD (%)</label>
          <input id="codReturnRate" type="number" class="input" value="0" min="0" max="100" />
          <i class="fas fa-undo input-icon"></i>
          <p class="input-desc">كام في المية بيرجّعوا الطلبات؟ (مثل: 20%)</p>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="section tab-content hidden">
      <h2 class="text-9xl font-bold mb-24 flex items-center gap-16">
        <i class="fas fa-tachometer-alt"></i> لوحة التحكم بتاعتك
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-22 mb-24">
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold text-5xl">إجمالي المبيعات</p>
          <p id="dashRevenue" class="text-10xl font-bold text-blue-600">ج.م 0</p>
          <p class="dashboard-desc">الفلوس اللي هتدخل جيبك بعد كل حاجة.</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold text-5xl">صافي الربح</p>
          <p id="dashNetProfit" class="text-10xl font-bold">ج.م 0</p>
          <p class="dashboard-desc">اللي هيفضل لك بعد ما تدفع كل المصاريف.</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold text-5xl">نقطة التعادل</p>
          <p id="dashBreakEven" class="text-10xl font-bold text-yellow-600">0 طلب</p>
          <p class="dashboard-desc">كام طلب لازم تبيعهم عشان تغطي التكاليف؟</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold text-5xl">ROI الإعلانات</p>
          <p id="dashROI" class="text-10xl font-bold text-purple-600">0%</p>
          <p class="dashboard-desc">كل جنيه بتصرفه بيرجع لك كام؟</p>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="costBreakdownChart"></canvas>
      </div>
      <div id="recommendations" class="recommendation">
        <h3 class="text-7xl font-bold mb-18">نصايح ذكية عشان تكسب أكتر</h3>
        <ul id="recommendationList" class="list-disc pr-16 text-6xl"></ul>
      </div>
      <div class="mt-24">
        <h3 class="text-7xl font-bold mb-18">جرب بنفسك: ماذا لو؟</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-22">
          <div class="input-group">
            <label class="block mb-2 font-semibold">السعر</label>
            <input type="range" id="priceSlider" class="slider" min="0" max="2000" value="0" />
            <p id="priceValue" class="input-desc">ج.م 0</p>
          </div>
          <div class="input-group">
            <label class="block mb-2 font-semibold">تكلفة الإعلان لكل طلب</label>
            <input type="range" id="adCostSlider" class="slider" min="0" max="50" value="0" />
            <p id="adCostValue" class="input-desc">ج.م 0</p>
          </div>
          <div class="input-group">
            <label class="block mb-2 font-semibold">نسبة المرتجعات</label>
            <input type="range" id="returnRateSlider" class="slider" min="0" max="100" value="0" />
            <p id="returnRateValue" class="input-desc">0%</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-20 mt-22 no-print">
      <button id="calculate" class="btn bg-green-600 text-white hover:bg-green-700">
        <i class="fas fa-calculator"></i> احسب كل حاجة
      </button>
      <button id="reset" class="btn bg-red-600 text-white hover:bg-red-700">
        <i class="fas fa-undo"></i> ابدأ من الأول
      </button>
      <button id="print" class="btn bg-gray-600 text-white hover:bg-gray-700">
        <i class="fas fa-print"></i> اطبع التقرير
      </button>
    </div>
  </div>

  <script>
    // البيانات العالمية
    let products = [{ name: "منتج 1", buyPrice: 0, shipping: 0, otherCosts: 0, expectedDeliveries: 0, targetSegment: "متوسطة" }];
    let competitors = [];
    let currency = "ج.م";
    let costChart = null;

    // تحميل البيانات من LocalStorage
    if (localStorage.getItem("products")) products = JSON.parse(localStorage.getItem("products"));
    if (localStorage.getItem("competitors")) competitors = JSON.parse(localStorage.getItem("competitors"));

    // تبديل التبويبات
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.remove("hidden");
      });
    });

    // عرض المنتجات
    function renderProducts() {
      const productList = document.getElementById("productList");
      productList.innerHTML = "";
      products.forEach((product, index) => {
        const div = document.createElement("div");
        div.className = "border rounded-lg p-20 bg-gray-50 shadow-sm transition-all duration-300 hover:bg-gray-100";
        div.innerHTML = `
          <div class="flex justify-between items-center mb-20">
            <div class="input-group w-1/4">
              <input type="text" value="${product.name}" class="input" data-index="${index}" data-field="name" placeholder="اسم المنتج" />
              <i class="fas fa-tag input-icon"></i>
              <p class="input-desc">المنتج ده اسمه إيه؟ (مثل: تيشيرت، حذاء)</p>
            </div>
            <button class="text-red-600 hover:text-red-800 no-print" data-index="${index}">
              <i class="fas fa-trash"></i> امسح المنتج
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-20">
            <div class="input-group">
              <label class="block mb-2 font-semibold">سعر الشراء</label>
              <input type="number" value="${product.buyPrice}" class="input" data-index="${index}" data-field="buyPrice" min="0" step="0.01" />
              <i class="fas fa-shopping-cart input-icon"></i>
              <p class="input-desc">جبت المنتج ده بكام؟ (مثل: 50 جنيه)</p>
            </div>
            <div class="input-group">
              <label class="block mb-2 font-semibold">تكلفة الشحن</label>
              <input type="number" value="${product.shipping}" class="input" data-index="${index}" data-field="shipping" min="0" step="0.01" />
              <i class="fas fa-truck input-icon"></i>
              <p class="input-desc">الشحن كلفك كام؟ (مثل: 20 جنيه)</p>
            </div>
            <div class="input-group">
              <label class="block mb-2 font-semibold">تكاليف تانية</label>
              <input type="number" value="${product.otherCosts}" class="input" data-index="${index}" data-field="otherCosts" min="0" step="0.01" />
              <i class="fas fa-tools input-icon"></i>
              <p class="input-desc">مصاريف زيادة؟ (مثل: 10 جنيه)</p>
            </div>
            <div class="input-group">
              <label class="block mb-2 font-semibold">التسليمات المتوقعة</label>
              <input type="number" value="${product.expectedDeliveries}" class="input" data-index="${index}" data-field="expectedDeliveries" min="0" />
              <i class="fas fa-shopping-bag input-icon"></i>
              <p class="input-desc">هتبيع كام وحدة في الشهر؟ (مثل: 50)</p>
            </div>
            <div class="input-group">
              <label class="block mb-2 font-semibold">الفئة المستهدفة</label>
              <select class="input" data-index="${index}" data-field="targetSegment">
                <option value="رخيصة" ${product.targetSegment === "رخيصة" ? "selected" : ""}>رخيصة (أقل من 300 جنيه)</option>
                <option value="متوسطة" ${product.targetSegment === "متوسطة" ? "selected" : ""}>متوسطة (300-1000 جنيه)</option>
                <option value="فاخرة" ${product.targetSegment === "فاخرة" ? "selected" : ""}>فاخرة (أكتر من 1000 جنيه)</option>
              </select>
              <i class="fas fa-users input-icon"></i>
              <p class="input-desc">هتبيع لمين؟ (رخيصة، متوسطة، فاخرة)</p>
            </div>
          </div>
        `;
        productList.appendChild(div);
      });

      productList.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", (e) => {
          const index = e.target.dataset.index;
          const field = e.target.dataset.field;
          products[index][field] = field === "name" || field === "targetSegment" ? e.target.value : Math.max(parseFloat(e.target.value) || 0, 0);
          localStorage.setItem("products", JSON.stringify(products));
          calculateAll();
        });
      });

      productList.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          if (products.length > 1) {
            products.splice(btn.dataset.index, 1);
            localStorage.setItem("products", JSON.stringify(products));
            renderProducts();
            calculateAll();
            showAlert("المنتج اتشال بنجاح!", "success");
          } else {
            showAlert("مش هينفع تمسح المنتج الوحيد!", "error");
          }
        });
      });
    }

    // عرض المنافسين
    function renderCompetitors() {
      const competitorList = document.getElementById("competitorList");
      competitorList.innerHTML = "";
      competitors.forEach((competitor, index) => {
        const div = document.createElement("div");
        div.className = "border rounded-lg p-20 bg-gray-50 shadow-sm transition-all duration-300 hover:bg-gray-100";
        div.innerHTML = `
          <div class="flex justify-between items-center mb-20">
            <div class="input-group w-1/4">
              <input type="text" value="${competitor.name}" class="input" data-index="${index}" data-field="name" placeholder="اسم المنافس" />
              <i class="fas fa-store input-icon"></i>
              <p class="input-desc">اسم المنافس ده إيه؟ (مثل: متجر فلان)</p>
            </div>
            <button class="text-red-600 hover:text-red-800 no-print" data-index="${index}">
              <i class="fas fa-trash"></i> امسح المنافس
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-20">
            <div class="input-group">
              <label class="block mb-2 font-semibold">سعر المنافس</label>
              <input type="number" value="${competitor.price}" class="input" data-index="${index}" data-field="price" min="0" step="0.01" />
              <i class="fas fa-dollar-sign input-icon"></i>
              <p class="input-desc">المنافس بيبيع المنتج بكام؟ (مثل: 200 جنيه)</p>
            </div>
            <div class="input-group">
              <label class="block mb-2 font-semibold">عدد المبيعات الشهرية</label>
              <input type="number" value="${competitor.sales}" class="input" data-index="${index}" data-field="sales" min="0" />
              <i class="fas fa-shopping-bag input-icon"></i>
              <p class="input-desc">كام وحدة بيبيعها في الشهر؟ (مثل: 100)</p>
            </div>
          </div>
        `;
        competitorList.appendChild(div);
      });

      competitorList.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", (e) => {
          const index = e.target.dataset.index;
          const field = e.target.dataset.field;
          competitors[index][field] = field === "name" ? e.target.value : Math.max(parseFloat(e.target.value) || 0, 0);
          localStorage.setItem("competitors", JSON.stringify(competitors));
          calculateAll();
        });
      });

      competitorList.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          competitors.splice(btn.dataset.index, 1);
          localStorage.setItem("competitors", JSON.stringify(competitors));
          renderCompetitors();
          calculateAll();
          showAlert("المنافس اتشال بنجاح!", "success");
        });
      });
    }

    // إضافة منتج
    document.getElementById("addProduct").addEventListener("click", () => {
      products.push({ name: `منتج ${products.length + 1}`, buyPrice: 0, shipping: 0, otherCosts: 0, expectedDeliveries: 0, targetSegment: "متوسطة" });
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts();
      calculateAll();
      showAlert("منتج جديد اتزوّد!", "success");
    });

    // إضافة منافس
    document.getElementById("addCompetitor").addEventListener("click", () => {
      competitors.push({ name: `منافس ${competitors.length + 1}`, price: 0, sales: 0 });
      localStorage.setItem("competitors", JSON.stringify(competitors));
      renderCompetitors();
      calculateAll();
      showAlert("منافس جديد اتزوّد!", "success");
    });

    // الحسابات الأساسية
    function calculateAll() {
      if (products.length === 0) {
        showAlert("لازم تزوّد منتج واحد على الأقل!", "error");
        return;
      }

      const cpc = Math.max(parseFloat(document.getElementById("cpc").value) || 0, 0);
      const clicks = Math.max(parseFloat(document.getElementById("clicks").value) || 0, 0);
      const conversionRate = Math.min(Math.max(parseFloat(document.getElementById("conversionRate").value) || 0, 0), 100);
      const codReturnRate = Math.min(Math.max(parseFloat(document.getElementById("codReturnRate").value) || 0, 0), 100);

      const productCosts = products.map(p => ({
        name: p.name,
        totalCost: p.buyPrice + p.shipping + p.otherCosts + 15, // 15 جنيه COD وتغليف افتراضي
        expectedDeliveries: p.expectedDeliveries,
        targetSegment: p.targetSegment
      }));

      const totalExpectedOrders = productCosts.reduce((sum, p) => sum + p.expectedDeliveries, 0);
      const adCost = cpc * clicks;
      const ordersFromAds = clicks * (conversionRate / 100);
      const deliveredOrders = ordersFromAds * (1 - codReturnRate / 100);
      const returnCost = ordersFromAds * (codReturnRate / 100) * 20; // تكلفة المرتجع 20 جنيه افتراضي

      // تحليل المنافسة
      const avgCompetitorPrice = competitors.length > 0 ? competitors.reduce((sum, c) => sum + c.price, 0) / competitors.length : 0;
      const competitorSales = competitors.reduce((sum, c) => sum + c.sales, 0);

      // السعر المثالي لكل منتج
      const suggestedPrices = productCosts.map(p => {
        let idealPrice = p.totalCost * 1.5; // هامش ربح أولي 50%
        if (avgCompetitorPrice > 0) {
          idealPrice = Math.min(idealPrice * 1.2, avgCompetitorPrice * 1.1); // تنافسية مع المنافسين
        }
        if (p.targetSegment === "رخيصة") idealPrice = Math.min(idealPrice, 300);
        else if (p.targetSegment === "متوسطة") idealPrice = Math.min(Math.max(idealPrice, 300), 1000);
        else if (p.targetSegment === "فاخرة") idealPrice = Math.max(idealPrice, 1000);
        return {
          name: p.name,
          totalCost: p.totalCost,
          idealPrice,
          profitPerOrder: idealPrice - p.totalCost
        };
      });

      // الحسابات المالية
      const totalRevenue = suggestedPrices.reduce((sum, p) => sum + p.idealPrice * p.expectedDeliveries, 0);
      const totalCost = suggestedPrices.reduce((sum, p) => sum + p.totalCost * p.expectedDeliveries, 0) + adCost + returnCost;
      const netProfit = totalRevenue - totalCost;
      const roi = adCost > 0 ? (netProfit / adCost) * 100 : 0;
      const breakEvenOrders = totalCost / (suggestedPrices[0]?.profitPerOrder || 1);

      // تحديث لوحة التحكم
      document.getElementById("dashRevenue").textContent = `${currency} ${totalRevenue.toFixed(2)}`;
      const dashNetProfit = document.getElementById("dashNetProfit");
      dashNetProfit.textContent = `${currency} ${netProfit.toFixed(2)}`;
      dashNetProfit.classList.toggle("negative", netProfit < 0);
      document.getElementById("dashBreakEven").textContent = `${Math.ceil(breakEvenOrders)} طلب`;
      document.getElementById("dashROI").textContent = `${roi.toFixed(2)}%`;

      // تحديث المخطط
      updateChart(totalCost - adCost - returnCost, adCost, returnCost);

      // التوصيات الذكية
      const recommendationList = document.getElementById("recommendationList");
      recommendationList.innerHTML = "";
      suggestedPrices.forEach(p => {
        if (avgCompetitorPrice > 0 && p.idealPrice < avgCompetitorPrice * 0.7) {
          recommendationList.innerHTML += `<li>سعر "${p.name}" أقل من السوق بكتير (${((avgCompetitorPrice - p.idealPrice) / avgCompetitorPrice * 100).toFixed(0)}%)، جرب تزوده شوية عشان تكسب أكتر!</li>`;
        }
        if (p.targetSegment === "متوسطة" && p.idealPrice > 800) {
          recommendationList.innerHTML += `<li>السعر بتاع "${p.name}" عالي على الطبقة المتوسطة، جرب عرض (اشتري 2 وخد 1 هدية) عشان تبيع أكتر!</li>`;
        }
        if (roi < 100) {
          recommendationList.innerHTML += `<li>الإعلانات مكلفة ومش بتجيب عائد كويس، جرب تستهدف ناس مختلفة أو تخفف الميزانية!</li>`;
        } else if (roi > 200) {
          recommendationList.innerHTML += `<li>الإعلانات بتاعك جامدة جدًا، زود الميزانية عشان تبيع أكتر!</li>`;
        }
        if (codReturnRate > 30) {
          recommendationList.innerHTML += `<li>المرتجعات عالية جدًا (${codReturnRate}%)، جرب تكلم العملاء قبل التوصيل عشان تقللها!</li>`;
        }
      });

      // تحديث المنزلقات
      const priceSlider = document.getElementById("priceSlider");
      const adCostSlider = document.getElementById("adCostSlider");
      const returnRateSlider = document.getElementById("returnRateSlider");
      priceSlider.value = suggestedPrices[0]?.idealPrice || 0;
      adCostSlider.value = cpc;
      returnRateSlider.value = codReturnRate;
      document.getElementById("priceValue").textContent = `${currency} ${priceSlider.value}`;
      document.getElementById("adCostValue").textContent = `${currency} ${adCostSlider.value}`;
      document.getElementById("returnRateValue").textContent = `${returnRateSlider.value}%`;

      priceSlider.oninput = () => {
        document.getElementById("priceValue").textContent = `${currency} ${priceSlider.value}`;
        simulateWhatIf(parseFloat(priceSlider.value), parseFloat(adCostSlider.value), parseFloat(returnRateSlider.value));
      };
      adCostSlider.oninput = () => {
        document.getElementById("adCostValue").textContent = `${currency} ${adCostSlider.value}`;
        simulateWhatIf(parseFloat(priceSlider.value), parseFloat(adCostSlider.value), parseFloat(returnRateSlider.value));
      };
      returnRateSlider.oninput = () => {
        document.getElementById("returnRateValue").textContent = `${returnRateSlider.value}%`;
        simulateWhatIf(parseFloat(priceSlider.value), parseFloat(adCostSlider.value), parseFloat(returnRateSlider.value));
      };
    }

    // تحديث المخطط
    function updateChart(productCost, adCost, returnCost) {
      if (costChart) costChart.destroy();
      costChart = new Chart(document.getElementById("costBreakdownChart").getContext("2d"), {
        type: "pie",
        data: {
          labels: ["تكلفة المنتجات", "الإعلانات", "المرتجعات"],
          datasets: [{
            data: [productCost, adCost, returnCost],
            backgroundColor: ["#3b82f6", "#ef4444", "#f59e0b"],
            borderWidth: 2,
            borderColor: "#fff"
          }]
        },
        options: {
          plugins: {
            legend: { position: "bottom", labels: { font: { size: 26 }, padding: 60 } },
            title: { display: true, text: "تفصيل المصاريف", font: { size: 34 }, padding: 60 }
          },
          animation: { duration: 4500, easing: "easeOutQuart" }
        }
      });
    }

    // محاكاة "ماذا لو؟"
    function simulateWhatIf(price, adCostPerClick, returnRate) {
      const clicks = Math.max(parseFloat(document.getElementById("clicks").value) || 0, 0);
      const conversionRate = Math.min(Math.max(parseFloat(document.getElementById("conversionRate").value) || 0, 0), 100);
      const totalCost = products[0].buyPrice + products[0].shipping + products[0].otherCosts + 15;
      const adCost = adCostPerClick * clicks;
      const orders = clicks * (conversionRate / 100);
      const deliveredOrders = orders * (1 - returnRate / 100);
      const returnCost = orders * (returnRate / 100) * 20;
      const revenue = price * deliveredOrders;
      const profit = revenue - (totalCost * deliveredOrders + adCost + returnCost);

      document.getElementById("dashRevenue").textContent = `${currency} ${revenue.toFixed(2)}`;
      document.getElementById("dashNetProfit").textContent = `${currency} ${profit.toFixed(2)}`;
      document.getElementById("dashNetProfit").classList.toggle("negative", profit < 0);
    }

    // عرض التنبيهات
    function showAlert(message, type) {
      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      document.querySelector(".container").prepend(alertDiv);
      setTimeout(() => alertDiv.remove(), 7000);
    }

    // أحداث المستمعين
    document.querySelectorAll("input, select").forEach(input => {
      input.addEventListener("input", debounce(calculateAll, 300));
    });

    document.getElementById("calculateIdealPrice").addEventListener("click", () => {
      calculateAll();
      showAlert("السعر المثالي اتحسب لك، شوفه في لوحة التحكم!", "success");
    });

    document.getElementById("calculate").addEventListener("click", () => {
      calculateAll();
      showAlert("كل حاجة اتحسبت بنجاح!", "success");
    });

    document.getElementById("reset").addEventListener("click", () => {
      products = [{ name: "منتج 1", buyPrice: 0, shipping: 0, otherCosts: 0, expectedDeliveries: 0, targetSegment: "متوسطة" }];
      competitors = [];
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("competitors", JSON.stringify(competitors));
      document.querySelectorAll("input:not([type='range'])").forEach(input => input.value = "0");
      renderProducts();
      renderCompetitors();
      calculateAll();
      showAlert("كل حاجة رجعت زي الأول!", "success");
    });

    document.getElementById("print").addEventListener("click", () => {
      window.print();
      showAlert("التقرير بيطبع دلوقتي!", "success");
    });

    // Debounce Function
    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    }

    // التهيئة الأولية
    renderProducts();
    renderCompetitors();
    calculateAll();
  </script>
</body>
</html>
