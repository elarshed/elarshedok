<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مستشار التجارة الإلكترونية الذكي - مصر</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      margin: 0;
      padding: 1rem;
      overflow-x: hidden;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1rem;
    }
    .section {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .tab {
      padding: 0.5rem 1.25rem;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-weight: 600;
      color: #4b5563;
      transition: all 0.3s ease;
      border-radius: 0.5rem 0.5rem 0 0;
      background: #f1f5f9;
    }
    .tab.active {
      border-color: #1e40af;
      color: #1e40af;
      background: #dbeafe;
    }
    .tab:hover {
      color: #1e40af;
      background: #eff6ff;
    }
    .input-group {
      margin-bottom: 1rem;
    }
    .input {
      width: 100%;
      padding: 0.5rem 2rem 0.5rem 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      background: #f9fafb;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }
    .input:focus {
      border-color: #1e40af;
      box-shadow: 0 0 6px rgba(30, 64, 175, 0.5);
      outline: none;
      background: white;
    }
    .input-icon {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }
    .input-desc {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .btn {
      padding: 0.5rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.15);
    }
    .dashboard-card {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .chart-container {
      height: 250px;
      width: 100%;
      background: white;
      border-radius: 0.75rem;
      padding: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .recommendation {
      background: #fef3c7;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-top: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .alert {
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .alert-error { background-color: #fee2e2; color: #991b1b; }
    .alert-success { background-color: #d1fae5; color: #065f46; }
    @media (max-width: 768px) {
      .container { padding: 0.75rem; }
      .section { padding: 1rem; }
      .tab { padding: 0.4rem 1rem; font-size: 0.75rem; }
      .input { font-size: 0.75rem; padding: 0.4rem 1.5rem 0.4rem 0.4rem; }
      .btn { padding: 0.4rem 1rem; font-size: 0.75rem; }
      .dashboard-card p:first-child { font-size: 0.75rem; }
      .dashboard-card p:nth-child(2) { font-size: 1.25rem; }
    }
    @media print {
      .no-print { display: none; }
      body { background: white; }
      .section { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-200 no-print">
      <span class="tab active" data-tab="product">المنتج</span>
      <span class="tab" data-tab="marketing">التسويق</span>
      <span class="tab" data-tab="shipping">الشحن</span>
      <span class="tab" data-tab="operations">التشغيل</span>
      <span class="tab" data-tab="dashboard">لوحة التحكم</span>
    </div>

    <!-- Product Section -->
    <div id="product" class="section tab-content active">
      <h2 class="text-2xl font-bold mb-4">بيانات المنتج والمصاريف</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">سعر شراء المنتج (جنيه)</label>
          <input id="buyPrice" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-shopping-cart input-icon"></i>
          <p class="input-desc">المنتج بيكلفك كام من المورد؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة الشحن الدولي (جنيه)</label>
          <input id="intlShipping" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-plane input-icon"></i>
          <p class="input-desc">الشحن من المورد لمصر كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">الجمارك والضرائب (جنيه)</label>
          <input id="customs" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-money-check input-icon"></i>
          <p class="input-desc">الجمارك كلفتك كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة التصنيع المحلي (جنيه)</label>
          <input id="manufacturing" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-tools input-icon"></i>
          <p class="input-desc">التصنيع المحلي كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة التغليف (جنيه)</label>
          <input id="packaging" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-box-open input-icon"></i>
          <p class="input-desc">التغليف بيكلف كام لكل وحدة؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة التخزين (جنيه)</label>
          <input id="storage" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-warehouse input-icon"></i>
          <p class="input-desc">التخزين بيكلف كام لكل وحدة؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة التأمين (جنيه)</label>
          <input id="insurance" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-shield-alt input-icon"></i>
          <p class="input-desc">التأمين كام لكل وحدة؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة مراقبة الجودة (جنيه)</label>
          <input id="qualityControl" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-check-circle input-icon"></i>
          <p class="input-desc">فحص الجودة بيكلف كام؟</p>
        </div>
      </div>
    </div>

    <!-- Marketing Section -->
    <div id="marketing" class="section tab-content hidden">
      <h2 class="text-2xl font-bold mb-4">بيانات التسويق والإعلانات</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">الميزانية الإعلانية الشهرية (جنيه)</label>
          <input id="adBudget" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-ad input-icon"></i>
          <p class="input-desc">بتصرف كام على الإعلانات شهريًا؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة النقرة (CPC) (جنيه)</label>
          <input id="cpc" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-mouse-pointer input-icon"></i>
          <p class="input-desc">كل نقرة بتكلفك كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">نسبة النقر (CTR) (%)</label>
          <input id="ctr" type="number" class="input" value="0" min="0" max="100" step="0.01" />
          <i class="fas fa-hand-pointer input-icon"></i>
          <p class="input-desc">كام في المية بينقروا على الإعلان؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">نسبة التحويل (Conversion Rate) (%)</label>
          <input id="conversionRate" type="number" class="input" value="0" min="0" max="100" step="0.01" />
          <i class="fas fa-percentage input-icon"></i>
          <p class="input-desc">كام في المية بيشتروا؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة اكتساب العميل (CPA) (جنيه)</label>
          <input id="cpa" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-user-plus input-icon"></i>
          <p class="input-desc">بتدفع كام عشان تجيب عميل؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">عدد الزوار المتوقع (شهريًا)</label>
          <input id="visitors" type="number" class="input" value="0" min="0" />
          <i class="fas fa-users input-icon"></i>
          <p class="input-desc">كام زائر بيتوقعوا؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة إنشاء المحتوى (جنيه)</label>
          <input id="contentCost" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-camera input-icon"></i>
          <p class="input-desc">المحتوى بيكلف كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة إدارة الإعلانات (جنيه)</label>
          <input id="adManagement" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-cogs input-icon"></i>
          <p class="input-desc">إدارة الإعلانات كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">نسبة التخلي عن السلة (%)</label>
          <input id="abandonRate" type="number" class="input" value="0" min="0" max="100" step="0.01" />
          <i class="fas fa-shopping-cart input-icon"></i>
          <p class="input-desc">كام في المية بيسيبوا السلة؟</p>
        </div>
      </div>
    </div>

    <!-- Shipping Section -->
    <div id="shipping" class="section tab-content hidden">
      <h2 class="text-2xl font-bold mb-4">بيانات الطلبات والشحن</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">عدد الطلبات المتوقع (شهريًا)</label>
          <input id="orders" type="number" class="input" value="0" min="0" />
          <i class="fas fa-shopping-bag input-icon"></i>
          <p class="input-desc">هتبيع كام طلب شهريًا؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">نسبة الطلبات الملغاة (%)</label>
          <input id="cancelRate" type="number" class="input" value="0" min="0" max="100" step="0.01" />
          <i class="fas fa-times input-icon"></i>
          <p class="input-desc">كام في المية بتلغي قبل الشحن؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">نسبة التسليم الناجح (%)</label>
          <input id="deliveryRate" type="number" class="input" value="0" min="0" max="100" step="0.01" />
          <i class="fas fa-truck input-icon"></i>
          <p class="input-desc">كام في المية بتتسلم بنجاح؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">نسبة المرتجعات (%)</label>
          <input id="returnRate" type="number" class="input" value="0" min="0" max="100" step="0.01" />
          <i class="fas fa-undo input-icon"></i>
          <p class="input-desc">كام في المية بيرجعوا المنتج؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة إعادة الشحن (جنيه)</label>
          <input id="returnShipping" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-truck-loading input-icon"></i>
          <p class="input-desc">إرجاع المنتج بيكلف كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة التخزين الإضافي (جنيه)</label>
          <input id="extraStorage" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-warehouse input-icon"></i>
          <p class="input-desc">تخزين المرتجعات بيكلف كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة الدفع عند الاستلام (جنيه)</label>
          <input id="codFees" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-money-bill input-icon"></i>
          <p class="input-desc">رسوم COD بتكلف كام؟</p>
        </div>
      </div>
    </div>

    <!-- Operations Section -->
    <div id="operations" class="section tab-content hidden">
      <h2 class="text-2xl font-bold mb-4">بيانات التشغيل والإدارة</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">عدد الموظفين والمرتبات (جنيه)</label>
          <input id="salaries" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-user-tie input-icon"></i>
          <p class="input-desc">مرتبات الفريق كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">عمولات الدفع الإلكتروني (%)</label>
          <input id="paymentFees" type="number" class="input" value="0" min="0" max="100" step="0.01" />
          <i class="fas fa-credit-card input-icon"></i>
          <p class="input-desc">نسبة بوابات الدفع كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">الاشتراكات الشهرية (جنيه)</label>
          <input id="subscriptions" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-file-invoice input-icon"></i>
          <p class="input-desc">الاشتراكات بتكلف كام؟</p>
        </div>
        <div class="input-group relative">
          <label class="block mb-1 font-semibold">تكلفة الصيانة والتطوير (جنيه)</label>
          <input id="maintenance" type="number" class="input" value="0" min="0" step="0.01" />
          <i class="fas fa-tools input-icon"></i>
          <p class="input-desc">الصيانة بتكلف كام؟</p>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="section tab-content hidden">
      <h2 class="text-2xl font-bold mb-4">لوحة التحكم</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">إجمالي المبيعات</p>
          <p id="totalRevenue" class="text-2xl font-bold text-blue-600">ج.م 0</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">صافي الربح</p>
          <p id="netProfit" class="text-2xl font-bold">ج.م 0</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">نقطة التعادل</p>
          <p id="breakEven" class="text-2xl font-bold text-yellow-600">0 طلب</p>
        </div>
        <div class="dashboard-card">
          <p class="text-gray-600 font-semibold">ROAS</p>
          <p id="roas" class="text-2xl font-bold text-purple-600">0%</p>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="costBreakdownChart"></canvas>
      </div>
      <div id="recommendations" class="recommendation">
        <h3 class="text-xl font-bold mb-3">التوصيات الذكية</h3>
        <ul id="recommendationList" class="list-disc pr-4 text-sm"></ul>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-3 mt-4 no-print">
      <button id="calculate" class="btn bg-green-600 text-white hover:bg-green-700">
        <i class="fas fa-calculator"></i> احسب كل حاجة
      </button>
      <button id="reset" class="btn bg-red-600 text-white hover:bg-red-700">
        <i class="fas fa-undo"></i> ابدأ من الأول
      </button>
      <button id="print" class="btn bg-gray-600 text-white hover:bg-gray-700">
        <i class="fas fa-print"></i> اطبع التقرير
      </button>
    </div>
  </div>

  <script>
    // Initialize IndexedDB
    const dbName = "EcommerceToolDB";
    let db;
    const request = indexedDB.open(dbName, 1);
    request.onupgradeneeded = (event) => {
      db = event.target.result;
      db.createObjectStore("data", { keyPath: "key" });
    };
    request.onsuccess = (event) => {
      db = event.target.result;
      loadData();
    };

    // Load data from IndexedDB
    function loadData() {
      const transaction = db.transaction(["data"], "readonly");
      const store = transaction.objectStore("data");
      const inputs = [
        "buyPrice", "intlShipping", "customs", "manufacturing", "packaging", "storage", "insurance", "qualityControl",
        "adBudget", "cpc", "ctr", "conversionRate", "cpa", "visitors", "contentCost", "adManagement", "abandonRate",
        "orders", "cancelRate", "deliveryRate", "returnRate", "returnShipping", "extraStorage", "codFees",
        "salaries", "paymentFees", "subscriptions", "maintenance"
      ];
      inputs.forEach(id => {
        const request = store.get(id);
        request.onsuccess = (event) => {
          if (event.target.result) {
            document.getElementById(id).value = event.target.result.value;
          }
        };
      });
      calculateAll();
    }

    // Save data to IndexedDB
    function saveData(id, value) {
      const transaction = db.transaction(["data"], "readwrite");
      const store = transaction.objectStore("data");
      store.put({ key: id, value });
    }

    // Global variables
    let costChart = null;
    const currency = "ج.م";

    // Tab switching
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.remove("hidden");
        calculateAll();
      });
    });

    // Calculate everything
    function calculateAll() {
      // Product Costs
      const buyPrice = parseFloat(document.getElementById("buyPrice").value) || 0;
      const intlShipping = parseFloat(document.getElementById("intlShipping").value) || 0;
      const customs = parseFloat(document.getElementById("customs").value) || 0;
      const manufacturing = parseFloat(document.getElementById("manufacturing").value) || 0;
      const packaging = parseFloat(document.getElementById("packaging").value) || 0;
      const storage = parseFloat(document.getElementById("storage").value) || 0;
      const insurance = parseFloat(document.getElementById("insurance").value) || 0;
      const qualityControl = parseFloat(document.getElementById("qualityControl").value) || 0;

      // Marketing Costs
      const adBudget = parseFloat(document.getElementById("adBudget").value) || 0;
      const cpc = parseFloat(document.getElementById("cpc").value) || 0;
      const ctr = Math.min(parseFloat(document.getElementById("ctr").value) || 0, 100) / 100;
      const conversionRate = Math.min(parseFloat(document.getElementById("conversionRate").value) || 0, 100) / 100;
      const cpa = parseFloat(document.getElementById("cpa").value) || 0;
      const visitors = parseFloat(document.getElementById("visitors").value) || 0;
      const contentCost = parseFloat(document.getElementById("contentCost").value) || 0;
      const adManagement = parseFloat(document.getElementById("adManagement").value) || 0;
      const abandonRate = Math.min(parseFloat(document.getElementById("abandonRate").value) || 0, 100) / 100;

      // Shipping & Orders
      const orders = parseFloat(document.getElementById("orders").value) || 0;
      const cancelRate = Math.min(parseFloat(document.getElementById("cancelRate").value) || 0, 100) / 100;
      const deliveryRate = Math.min(parseFloat(document.getElementById("deliveryRate").value) || 0, 100) / 100;
      const returnRate = Math.min(parseFloat(document.getElementById("returnRate").value) || 0, 100) / 100;
      const returnShipping = parseFloat(document.getElementById("returnShipping").value) || 0;
      const extraStorage = parseFloat(document.getElementById("extraStorage").value) || 0;
      const codFees = parseFloat(document.getElementById("codFees").value) || 0;

      // Operations Costs
      const salaries = parseFloat(document.getElementById("salaries").value) || 0;
      const paymentFees = Math.min(parseFloat(document.getElementById("paymentFees").value) || 0, 100) / 100;
      const subscriptions = parseFloat(document.getElementById("subscriptions").value) || 0;
      const maintenance = parseFloat(document.getElementById("maintenance").value) || 0;

      // Calculations
      const totalUnitCost = buyPrice + intlShipping + customs + manufacturing + packaging + storage + insurance + qualityControl;
      const totalFixedCosts = salaries + subscriptions + maintenance + contentCost + adManagement;
      const totalAdCost = adBudget || (cpc * visitors * ctr);
      const completedOrders = orders * (1 - cancelRate) * deliveryRate;
      const returnedOrders = completedOrders * returnRate;
      const totalReturnCost = returnedOrders * (returnShipping + extraStorage);
      const totalCostPerOrder = totalUnitCost + (totalFixedCosts + totalAdCost + totalReturnCost + codFees) / (completedOrders || 1);
      const idealPrice = Math.round(totalCostPerOrder * 1.5); // 50% profit margin
      const revenue = idealPrice * completedOrders;
      const netProfitPerOrder = idealPrice - totalCostPerOrder;
      const totalNetProfit = netProfitPerOrder * completedOrders;
      const profitMargin = (netProfitPerOrder / idealPrice) * 100;
      const breakEvenPrice = totalCostPerOrder;
      const breakEvenPoint = totalFixedCosts / (netProfitPerOrder || 1);
      const roas = totalAdCost ? (revenue / totalAdCost) : 0;
      const idealCPA = idealPrice * 0.3; // 30% of selling price as ideal CPA
      const cashFlow = revenue - (totalFixedCosts + totalAdCost + totalReturnCost);
      const minOrdersForCashFlow = totalFixedCosts / (netProfitPerOrder || 1);

      // Update Dashboard
      document.getElementById("totalRevenue").textContent = `${currency} ${revenue.toFixed(2)}`;
      const netProfitEl = document.getElementById("netProfit");
      netProfitEl.textContent = `${currency} ${totalNetProfit.toFixed(2)}`;
      netProfitEl.classList.toggle("text-red-600", totalNetProfit < 0);
      document.getElementById("breakEven").textContent = `${Math.ceil(breakEvenPoint)} طلب`;
      document.getElementById("roas").textContent = `${(roas * 100).toFixed(2)}%`;

      // Update Chart
      updateChart(totalUnitCost * completedOrders, totalAdCost, totalReturnCost);

      // Recommendations
      const recommendationList = document.getElementById("recommendationList");
      recommendationList.innerHTML = "";
      if (profitMargin < 10) {
        recommendationList.innerHTML += `<li>هامش الربح (${profitMargin.toFixed(2)}%) ضعيف، جرب تقلل التكاليف أو تزود السعر!</li>`;
      }
      if (roas < 1) {
        recommendationList.innerHTML += `<li>الإعلانات مش مربحة (ROAS: ${(roas * 100).toFixed(2)}%)، جرب تحسن الاستهداف!</li>`;
      } else if (roas > 3) {
        recommendationList.innerHTML += `<li>الإعلانات قوية (ROAS: ${(roas * 100).toFixed(2)}%)، زود الميزانية عشان تبيع أكتر!</li>`;
      }
      if (returnRate > 0.2) {
        recommendationList.innerHTML += `<li>المرتجعات عالية (${(returnRate * 100).toFixed(2)}%)، أكد الطلبات قبل الشحن!</li>`;
      }
      if (abandonRate > 0.5) {
        recommendationList.innerHTML += `<li>التخلي عن السلة عالي (${(abandonRate * 100).toFixed(2)}%)، جرب عرض خصم للي يسيبوا السلة!</li>`;
      }
      if (cashFlow < 0) {
        recommendationList.innerHTML += `<li>التدفق النقدي سالب (${cashFlow.toFixed(2)} ج.م)، جرب تقلل المصاريف!</li>`;
      }
      if (idealPrice < totalCostPerOrder) {
        recommendationList.innerHTML += `<li>السعر المثالي (${idealPrice} ج.م) أقل من التكلفة (${totalCostPerOrder.toFixed(2)} ج.م)، لازم تزوده!</li>`;
      }
    }

    // Update Chart
    function updateChart(productCost, adCost, returnCost) {
      if (costChart) costChart.destroy();
      costChart = new Chart(document.getElementById("costBreakdownChart").getContext("2d"), {
        type: "pie",
        data: {
          labels: ["تكلفة المنتجات", "الإعلانات", "المرتجعات"],
          datasets: [{
            data: [productCost, adCost, returnCost],
            backgroundColor: ["#3b82f6", "#ef4444", "#f59e0b"],
            borderWidth: 1,
            borderColor: "#fff"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom", labels: { font: { size: 10 } } },
            title: { display: true, text: "تفصيل المصاريف", font: { size: 14 } }
          }
        }
      });
    }

    // Event Listeners
    document.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", () => {
        saveData(input.id, input.value);
        debounce(calculateAll, 200)();
      });
    });

    document.getElementById("calculate").addEventListener("click", () => {
      calculateAll();
      showAlert("كل حاجة اتحسبت بنجاح!", "success");
    });

    document.getElementById("reset").addEventListener("click", () => {
      document.querySelectorAll("input").forEach(input => input.value = "0");
      const transaction = db.transaction(["data"], "readwrite");
      const store = transaction.objectStore("data");
      store.clear();
      calculateAll();
      showAlert("كل حاجة رجعت زي الأول!", "success");
    });

    document.getElementById("print").addEventListener("click", () => {
      window.print();
      showAlert("التقرير بيطبع دلوقتي!", "success");
    });

    // Show Alert
    function showAlert(message, type) {
      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
      document.querySelector(".container").prepend(alertDiv);
      setTimeout(() => alertDiv.remove(), 4000);
    }

    // Debounce Function
    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), delay);
      };
    }

    // Initial Calculation
    calculateAll();
  </script>
</body>
</html>
